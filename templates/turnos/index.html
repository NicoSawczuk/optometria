{%extends 'home/home.html'%}
{%load static%}

{%block titulo%} Turnos {%endblock titulo%}

{%block body%}

<div class="card">
    <div class="card-header bg-light">
        <strong>Turnos</strong>
        <a class="btn btn-primary btn-sm float-right text-white" href="/home/turnos/create">Nuevo</a>
    </div>
    <div class="card-body card-block">
        <table id="datatable" class="table table-striped table-bordered dataTable">
            <thead>
                <tr>
                    <th scope="col">Paciente</th>
                    <th scope="col">Medico</th>
                    <th scope="col">F. del turno</th>
                    <th scope="col">Detalle</th>
                    <th scope="col">Estado</th>
                    <th scope="col" class="text-right">Opciones</th>
                </tr>
            </thead>
            <tbody>
                {% for turno in turnos %}
                <tr>
                    <td>{{turno.paciente.nombre}} {{turno.paciente.apellido}}</td>
                    <td>{{turno.medico.nombre}} {{turno.medico.apellido}}</td>
                    <td>{{turno.fecha}}</td>
                    <td>{{turno.detalle}}</td>
                    {%if turno.activo%}
                    <td><span class="badge badge-danger">Sin atender</span></td>
                    {%else%}
                    <td><span class="badge badge-success">Atendido</span></td>
                    {%endif%}
                    <td class="text-right">
                        <a title="Observaciones" class="btn btn-light btn-sm"
                            onclick="openModalObservacion('{{turno.paciente.id}}','{{turno.activo}}')"><i
                                class="fal fa-book-medical fa-lg"></i></a>
                        <a title="Editar" class="btn btn-light btn-sm" href="/home/turnos/edit/{{turno.id}}"><i
                                class="fal fa-edit fa-lg"></i></a>
                        <a title="Eliminar turno" onclick="openModalDelete('{{turno.id}}')"
                            class="btn btn-danger btn-sm"><i class="fal fa-trash fa-lg"></i></a>
                    </td>
                </tr>
                {%endfor%}
            </tbody>
        </table>
    </div>
</div>
<div id="observacionesModal" class="modal fade bd-example-modal-xl" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Observaciones</h2>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="botonNuevaObservacion" style="display: none;">
                    <a class="btn btn-success btn-sm text-white mb-2" onClick="mostrarFormObservacion()">Nueva
                        observación</a>
                </div>
                <div class="form-group row" id="formNuevaObservacion" style="display: none;">
                    <form method="POST" action="/home/pacientes/observaciones/create">
                        {% csrf_token %}
                        <div class="form-group col-md-7">
                            <label for="nombre" class=" col-form-label text-md-right">Detalle</label>
                            <textarea id="detalle" type="text" class="form-control" name="detalle" value=""
                                placeholder="Ingrese el detalle" pattern="[A-Za-z]{}" required></textarea>
                            <input type="hidden" id="inputNuevaObservacion" name="id">
                            <button type="submit" class="btn btn-sm btn-primary mt-1"><i class="fal fa-check"></i>
                                Guardar</button>
                        </div>
                    </form>
                </div>
                <ul class="list-group list-group-flush">
                    <div id="observaciones"></div>

                </ul>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cerrar</button>
            </div>
        </div>
    </div>
</div>

<div id="eliminarTurno" class="modal fade bd-example-modal-xl" role="dialog">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Eliminar turno</h2>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div class="modal-body">
                <form method="POST" id="formDelete">
                    {% csrf_token %}
                    <h5 align="center" style="margin:0;">¿Esta seguro que desea borrar el turno?</h5>


            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancelar</button>
                <button type="submit" class="btn btn-danger"><i class="fal fa-check"></i>Borrar</button>
            </div>
            </form>
        </div>
    </div>
</div>

{%endblock body%}
{%block scripts%}
{{ block.super }}
{% if messages %}
{% for message in messages %}
{% if message.tags == 'success'%}
<script>
    toastr.success(' {{message}} ', 'Correcto')
</script>
{%endif%}
{% if message.tags == 'error'%}
<script>
    toastr.error(' {{message}} ', 'Error')
</script>
{%endif%}
{% endfor %}
{% endif %}

<script>
    function openModalObservacion(id, activo) {
        $('#observacionesModal').modal('show');
        console.log(typeof (activo))
        if (activo == 'True') {
            $('#botonNuevaObservacion').css("display", "block");
        } else {
            $('#botonNuevaObservacion').css("display", "none");
        }

        $('#inputNuevaObservacion').val(id)
        $.ajax({
            data: { 'id': id },
            url: '/home/pacientes/observaciones', //El id que estoy guardando en data se va a enviar en esa url
            type: 'get',
            success: function (data) {
                var html = ""
                console.log(data)

                for (var i = 0; i < data.length; i++) {
                    html += '<li class="list-group-item">' + '<div class="row">' +
                        '<div class="col-9">'
                        + data[i].fields.detalle +
                        '</div>' +
                        '<div class="col-3 text-muted">'
                        + data[i].fields.fecha.substring(8, 10) + '/' + data[i].fields.fecha.substring(5, 7) + '/' + data[i].fields.fecha.substring(0, 4) +
                        '</div>' +
                        '</div>' + '</li>'

                }
                $('#observaciones').html(html);

            },
        });
    }

    function mostrarFormObservacion() {
        if ($("#formNuevaObservacion").css("display") === 'block') {
            $("#formNuevaObservacion").css("display", "none");
        } else {
            $("#formNuevaObservacion").css("display", "block");
        }
    }

    function openModalDelete(id) {
        $('#eliminarTurno').modal('show');

        $('#formDelete').attr('action', '/home/turnos/delete/' + id);
    }

</script>
{%endblock scripts%}